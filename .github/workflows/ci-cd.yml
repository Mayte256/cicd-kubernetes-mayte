name: CI/CD Pipeline con Kubernetes

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-test-deploy-kubernetes:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout del cÃ³digo
      uses: actions/checkout@v3
    
    - name: ğŸ“‹ Verificar estructura de archivos
      run: |
        echo "=== Archivos en el repositorio ==="
        ls -la
        echo ""
        echo "=== Contenido de requirements.txt ==="
        cat requirements.txt
        echo ""
    
    - name: ğŸ Configurar Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Instalar dependencias Python
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
          echo "âœ… Dependencias instaladas correctamente"
        else
          echo "âŒ ERROR: No se encuentra requirements.txt"
          exit 1
        fi
    
    - name: âœ… Validar cÃ³digo Python
      run: |
        python -m py_compile app.py
        echo "âœ… Sintaxis de Python vÃ¡lida"
    
    - name: ğŸ§ª Ejecutar tests unitarios
      run: |
        python -c "from app import app; print('âœ… App importada correctamente')"
        python -c "from app import app; client = app.test_client(); response = client.get('/health'); assert response.status_code == 200; print('âœ… Health check funciona')"
        echo "âœ… Todos los tests pasaron"
    
    - name: ğŸ·ï¸ Generar tag Ãºnico
      id: tag
      run: |
        SHORT_SHA=$(git rev-parse --short HEAD)
        echo "image_tag=$SHORT_SHA" >> $GITHUB_OUTPUT
        echo "Tag generado: $SHORT_SHA"
    
    - name: ğŸ³ Construir imagen Docker con tag Ãºnico
      run: |
        docker build -t cicd-kubernetes-mayte:${{ steps.tag.outputs.image_tag }} .
        docker tag cicd-kubernetes-mayte:${{ steps.tag.outputs.image_tag }} cicd-kubernetes-mayte:latest
        docker images | grep cicd-kubernetes-mayte
        echo "âœ… Imagen Docker construida con tag: ${{ steps.tag.outputs.image_tag }}"
    
    - name: ğŸ§ª Test rÃ¡pido del contenedor Docker
      run: |
        echo "Probando contenedor Docker..."
        docker run -d --name test-container -p 5000:5000 cicd-kubernetes-mayte:${{ steps.tag.outputs.image_tag }}
        sleep 10
        curl -f http://localhost:5000/health || echo "Container no estÃ¡ listo todavÃ­a"
        docker logs test-container
        docker stop test-container
        docker rm test-container
        echo "âœ… Test de contenedor completado"
    
    - name: â˜¸ï¸ Instalar Minikube
      run: |
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        sudo install minikube-linux-amd64 /usr/local/bin/minikube
        minikube version
        echo "âœ… Minikube instalado"
    
    - name: â˜¸ï¸ Iniciar cluster de Kubernetes
      run: |
        minikube start --driver=docker --cpus=2 --memory=2048
        minikube status
        echo "âœ… Cluster de Kubernetes iniciado"
    
    - name: â˜¸ï¸ Configurar kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'
    
    - name: â˜¸ï¸ Verificar cluster
      run: |
        kubectl cluster-info
        kubectl get nodes
        echo "âœ… Cluster funcionando"
    
    - name: â˜¸ï¸ Cargar imagen en Minikube con tag Ãºnico
      run: |
        minikube image load cicd-kubernetes-mayte:${{ steps.tag.outputs.image_tag }}
        minikube image load cicd-kubernetes-mayte:latest
        echo "âœ… Imagen cargada en Minikube"
    
    - name: â˜¸ï¸ Desplegar en Kubernetes
      run: |
        kubectl apply -f kubernetes/deployment.yaml
        kubectl apply -f kubernetes/service.yaml
        echo "âœ… Manifiestos aplicados"
    
    - name: ğŸ”„ Actualizar deployment con nuevo tag
      run: |
        kubectl set image deployment/cicd-kubernetes-mayte cicd-kubernetes-mayte=cicd-kubernetes-mayte:${{ steps.tag.outputs.image_tag }}
        echo "âœ… Deployment actualizado con tag: ${{ steps.tag.outputs.image_tag }}"
    
    - name: â³ Esperar rollout completado
      run: |
        echo "Esperando que el rollout se complete..."
        kubectl rollout status deployment/cicd-kubernetes-mayte --timeout=120s
        echo "âœ… Rollout completado"
    
    - name: ğŸ“Š Estado del despliegue
      run: |
        echo "=== PODS ==="
        kubectl get pods -l app=cicd-kubernetes-mayte -o wide
        echo ""
        echo "=== DEPLOYMENT ==="
        kubectl get deployment cicd-kubernetes-mayte
        echo ""
        echo "=== SERVICE ==="
        kubectl get service cicd-kubernetes-mayte-service
        echo ""
        echo "=== DESCRIBE PODS ==="
        kubectl describe pods -l app=cicd-kubernetes-mayte
    
    - name: ğŸ§ª Probar aplicaciÃ³n en Kubernetes
      run: |
        echo "Obteniendo nombre del pod..."
        POD_NAME=$(kubectl get pods -l app=cicd-kubernetes-mayte -o jsonpath='{.items[0].metadata.name}')
        echo "Pod encontrado: $POD_NAME"
        
        echo "Verificando que el pod estÃ© corriendo..."
        kubectl get pod $POD_NAME
        
        echo "Probando conexiÃ³n al pod directamente..."
        kubectl port-forward pod/$POD_NAME 8080:5000 &
        PF_PID=$!
        sleep 10
        
        echo "Haciendo request al pod..."
        curl -v http://localhost:8080/health || echo "Primera prueba fallÃ³, reintentando..."
        sleep 5
        curl -v http://localhost:8080/health || echo "No se pudo conectar al pod"
        
        kill $PF_PID || true
        echo "âœ… Test completado"
    
    - name: ğŸ“‹ Logs de pods
      if: always()
      run: |
        echo "=== LOGS DE TODOS LOS PODS ==="
        for pod in $(kubectl get pods -l app=cicd-kubernetes-mayte -o jsonpath='{.items[*].metadata.name}'); do
          echo "--- Logs del pod: $pod ---"
          kubectl logs $pod --tail=50 || echo "No se pudieron obtener logs"
          echo ""
        done
    
    - name: ğŸ“ˆ Recursos finales
      if: always()
      run: |
        echo "=== TODOS LOS RECURSOS ==="
        kubectl get all
        echo ""
        echo "=== EVENTOS RECIENTES ==="
        kubectl get events --sort-by='.lastTimestamp' | tail -20
    
    - name: ğŸ‰ Resumen del pipeline
      if: success()
      run: |
        echo "========================================"
        echo "âœ… PIPELINE CI/CD COMPLETADO CON Ã‰XITO"
        echo "========================================"
        echo "âœ… CÃ³digo validado"
        echo "âœ… Tests unitarios pasados"
        echo "âœ… Imagen Docker construida con tag: ${{ steps.tag.outputs.image_tag }}"
        echo "âœ… Cluster Kubernetes iniciado"
        echo "âœ… AplicaciÃ³n desplegada en Kubernetes"
        echo "âœ… Deployment actualizado automÃ¡ticamente"
        echo "âœ… Pods verificados"
        echo "âœ… Service configurado"
        echo "========================================"
        echo "ğŸš€ DESPLIEGUE KUBERNETES EXITOSO"
        echo "========================================"